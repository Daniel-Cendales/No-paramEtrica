---
title: Taller Preparatorio Parcial \#1
author: 
   - Hernan Supelano
   - Daniel Felipe Cendales
output: 
        pdf_document:
                extra_dependencies: ["enumerate"]
---

# Estimación histograma


1. Realizamos una simulación de tamaño 100 de $X \sim \mathcal{N}(\mu = 17, \sigma^2 = 4)$ 

```{r Primer punto}
## Ajustamos los parámetros iniciales
n <- 100                                        # Tamaño de la muestra
mu <- 20                                        # Media teórica              
sigma <- 2                                      # Desv. estándar teórica
set.seed(n)                                     # Fijamos la semilla

# Tomamos la muestra
datos <- rnorm(n = n, mean = mu, sd = sigma)

## Estimación histograma
histograma <- hist(datos, plot = FALSE)
```

a. Notemos que:

```{r punto1.a}
# Extraemos la estimación histograma de la densidad
densidad1 <- histograma$density

# Extraemos los conteos y los extremos de un intervalo
ni <- histograma$counts
cortes <- histograma$breaks[1:2]                # Los dos primeros puntos
b <- diff(cortes)/2                             # Distancia sobre 2
densidad2 <- ni / (2*n*b)                       # Los conteos
                                                
# Comparamos los vectores
all.equal(densidad1, densidad2)                 # Hacemos la comparación
```
                                        
b. Sea $x$ el punto medio de un intervalo. Vamos a plantar dos casos:
- **Caso 1:** la distancia del punto medio de un intervalo a uno de los extremos es $b$, lo que implica que la longitud de los intervalos es de $2b$. Entonces
\begin{eqnarray*}
    n_j &=& \#\{x_i: x - b \leq x_i \leq x + b\} \\
        &=& \#\{x_i: -b \leq x_i - x \leq b\} \\
        &=& \#\left\{x_i: -1 \leq \frac{x_i - x}{b} \leq 1\right\} \\
        &=& \sum\limits_{i = 1}^{n} I_{[-1, 1]}\left(\frac{x_i - x}{b}\right)
\end{eqnarray*}

Y por ende la estimación histograma toma la forma:

\begin{eqnarray*}
    \widehat{f_H}(x) &=& \frac{n_j}{2bn} \\
                     &=& \frac{1}{2bn}\sum\limits_{i = 1}^{n} I_{[-1, 1]}\left(\frac{x_i - x}{b}\right) \\
                     &=& \frac{1}{nb}\sum\limits_{i = 1}^{n}\frac{1}{2}I_{[-1, 1]}\left(\frac{x_i - x}{b}\right)
\end{eqnarray*}

- **Caso 2:** la longitud del intervalo es $b$. Es decir que la distancia del punto medio a uno de los extremos es $b/2$. Entonces 
\begin{eqnarray*}
    n_j &=& \#\left\{x_i: x - \frac{b}{2} \leq x_i \leq x + \frac{b}{2}\right\} \\
        &=& \#\left\{x_i: -\frac{b}{2}\leq x_i - x \leq \frac{b}{2}\right\} \\
        &=& \#\left\{x_i: -\frac{1}{2}\leq \frac{x_i - x}{b} \leq \frac{1}{2}\right\} \\
        &=& \sum\limits_{i = 1}^{n} I_{\left[-\frac{1}{2}, \frac{1}{2}\right]}\left(\frac{x_i - x}{b}\right)
\end{eqnarray*}

Y por ende la estimación histograma toma la forma:

\begin{eqnarray*}
    \widehat{f_H}(x) &=& \frac{n_j}{bn} \\
                     &=& \frac{1}{bn}\sum\limits_{i = 1}^{n} I_{\left[-\frac{1}{2}, \frac{1}{2}\right]}\left(\frac{x_i - x}{b}\right)
\end{eqnarray*}

c. Gráfico de curvas teóricas y sus estimaciones.

Primero debemos calcular el $b$ óptimo. Para ello, recordemos la fórmula (asumimos normalidad sobre $f$)

$$b = 3.491\cdot\hat{\sigma}\cdot n^{-1/3}$$

donde $\hat{\sigma} = \frac{\text{RIC}}{1.35}$

Pero el $b$ óptimo necesita de $\sigma$ y no de $\hat{\sigma}$. Entonces lo primero que hacemos será realizar varias simulaciones para encontrar el valor óptimo.

Calculemos entonces las cantidades necesarias:

```{r simulaciones1c}
# Inicio de las simulaciones
N <- 500                                        # Cantidad de simulaciones
muestras <- matrix(0, nrow = n, ncol = N)
b0s <- NULL                                     # Almacenamos los b's 
                                                
for(i in 1:N)
{
    muestras[, i] <- rnorm(n, mean = mu, sd = sigma)
    RICs <- diff(quantile(muestras[, i], probs = c(1, 3)/4, names = FALSE))
    sigmas_hat <- min(RICs / 1.35, sd(muestras[, i]))
    b0s[i] <- 3.491 * sigmas_hat * n^(-1/3) 
}

# Cálculo del b óptimo como promedio de todos los b's
( b_Optimo <- mean(b0s) )

# b óptimo obtenido de la muestra
min(diff(quantile(datos, probs = c(1, 3)/4, names = FALSE)) / 1.35, sd(datos))
```
Ya calculado el $b$ óptimo, podemos hacer la gráfica de la densidad teórica y la estimación que obtuvimos

```{r gráfico, warning = FALSE}
# A 4 desviaciones estándar (de la media), en una normal, estará el 99%
lImites <- mu + c(-1, 1) * 5 * sigma

# Extremos de los intervalos
puntos <- seq(from = lImites[1] - 1, to = lImites[2] + 1, by = b_Optimo)

# Histograma con el ancho de banda óptimo
Hist <- hist(datos, breaks = puntos, plot = FALSE)

# Curva teórica
rango <- seq(from = lImites[1], to = lImites[2], by = 0.1)
plot(x = rango, y = dnorm(rango, mu, sigma), frame = FALSE, 
     xlab = "X", ylab = "Densidad", type = "l", las = 1, 
     lwd = 2, ylim = c(0, max(Hist$density)), col = "blue", 
     main = bquote("Estimación histograma, b" == .(round(b_Optimo, 3))))

# Gráfico del histograma
lines(x = puntos, y = c(Hist$density, 0), type = "s")

# Leyenda
legend(x = "topright", lwd = 2:1, col = c("blue", "black"), 
       legend = c("Teórica", "Histograma"), bty = "n")
```

Para agregar la curva de $E\left\{\widehat{f_H}(x)\right\}$ vamos a usar la muestras generadas, calculamos el promedio y las varianzas

```{r Repeticiones}
# Obtenemos los histogramas de cada muestra
histogramas <- apply(muestras, 2, function(k){
                         c(hist(k, breaks = puntos, plot = FALSE)$density, 0)
                     })
E_fh <- apply(histogramas, 1, mean)             # Valor esperado
Sd_fh <- apply(histogramas, 1, sd)              # Desviación estándar

plot(x = rango, y = dnorm(rango, mu, sigma), frame = FALSE, 
     xlab = "X", ylab = "Densidad", type = "l", las = 1, 
     lwd = 2, ylim = c(0, max(Hist$density)), col = "blue", 
     main = bquote("Estimación histograma, b" == .(round(b_Optimo, 3))))

# Gráfico del histograma
lines(x = puntos, y = c(Hist$density, 0), type = "s", lty = 2)

# Esperanza
lines(x = puntos, y = E_fh, col = "brown", lwd = 2, type = "l")

# Leyenda
legend(x = "topright", lwd = c(2, 1, 2), col = c("blue", "black", "brown"), 
       legend = c("Teórica", "Histograma", "Esperanza"), bty = "n",
       lty = c(1, 2, 1))
```

Para intentar ver el comportamiento de la varianza, podemos graficar todos los histogramas obtenidos y después agregamos unas "bandas de confianza"

```{r muchos histogramas}
# Todos los histogramas obtenidos
matplot(x = puntos, y = histogramas, type = "s", las = 1,
        col = "gray", lty = 1, frame = FALSE, lwd = 0.5, 
        xlab = "observados")

# El histograma de la muestra inicial
lines(x = puntos, y = c(Hist$density, 0), col = "black", 
      lwd = 2, type = "s", lty = 5)

# Valor esperado
lines(x = puntos, y = E_fh, col = "brown", lwd = 2, type = "l")

# Estimación teórica
lines(rango, dnorm(rango, mean = mu, sd = sigma), col = "blue")

# "Bandas de confianza"
matlines(x = puntos, y = cbind(E_fh - 1.96 * Sd_fh, 
                               E_fh + 1.96 * Sd_fh), 
         type = "l", col = "cyan2", lty = 1, lwd = 1)

```
